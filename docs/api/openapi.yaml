openapi: 3.0.3
info:
  title: NEWYM CRM API
  description: |
    API Documentation for NEWYM CRM System
    
    This API provides endpoints for managing CRM clients, interactions, and Google Calendar integration.
    
    ## Authentication
    All API requests require authentication via Supabase JWT token in the Authorization header:
    ```
    Authorization: Bearer <access_token>
    ```
    
    ## Base URL
    - Production: `https://<project-ref>.supabase.co`
    - Local Development: `http://localhost:54321`
    
  version: 1.0.0
  contact:
    name: NEWYM Support
    email: support@newym.com

servers:
  - url: https://{project-ref}.supabase.co
    description: Production Server
    variables:
      project-ref:
        default: your-project-ref
  - url: http://localhost:54321
    description: Local Development Server

tags:
  - name: CRM Clients
    description: Operations for managing CRM clients
  - name: Client Interactions
    description: Operations for managing client interactions
  - name: Google Calendar
    description: Google Calendar integration operations
  - name: CRM Analytics
    description: Analytics and reporting operations

paths:
  /rest/v1/google_calendar_clients:
    get:
      tags:
        - CRM Clients
      summary: Get clients from Google Calendar
      description: |
        Retrieves all clients associated with a trainer from the Google Calendar sync.
        Clients are ordered by last_event_date in descending order (most recent first).
      operationId: getClientsFromCalendar
      security:
        - bearerAuth: []
      parameters:
        - name: trainer_id
          in: query
          required: true
          description: The unique identifier of the trainer
          schema:
            type: string
            format: uuid
        - name: select
          in: query
          required: false
          description: Comma-separated list of columns to select
          schema:
            type: string
            default: "*"
        - name: order
          in: query
          required: false
          description: Order by column
          schema:
            type: string
            default: "last_event_date.desc"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CalendarClient'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /rest/v1/client_interactions:
    post:
      tags:
        - Client Interactions
      summary: Create a new client interaction
      description: |
        Creates a new client interaction record and automatically updates the trainee's
        last_contact_date and next_followup_date fields.
      operationId: createClientInteraction
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateClientInteraction'
      responses:
        '201':
          description: Interaction created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClientInteraction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'
    get:
      tags:
        - Client Interactions
      summary: Get client interactions
      description: Retrieves all interactions for a specific trainee
      operationId: getClientInteractions
      security:
        - bearerAuth: []
      parameters:
        - name: trainee_id
          in: query
          required: true
          description: The unique identifier of the trainee
          schema:
            type: string
            format: uuid
        - name: order
          in: query
          required: false
          description: Order by column
          schema:
            type: string
            default: "interaction_date.desc"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ClientInteraction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /functions/v1/google-oauth:
    get:
      tags:
        - Google Calendar
      summary: Initiate Google OAuth flow
      description: |
        Initiates the Google OAuth flow and returns the authorization URL.
        The user should be redirected to this URL to complete authentication.
      operationId: initiateGoogleOAuth
      security:
        - bearerAuth: []
      parameters:
        - name: trainer_id
          in: query
          required: true
          description: The unique identifier of the trainer
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: OAuth URL generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  authUrl:
                    type: string
                    format: uri
                    description: Google OAuth authorization URL
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /functions/v1/google-oauth/callback:
    post:
      tags:
        - Google Calendar
      summary: Handle Google OAuth callback
      description: |
        Handles the OAuth callback from Google and stores the access tokens.
        This endpoint is called by Google after user authorization.
      operationId: handleGoogleOAuthCallback
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
                - state
              properties:
                code:
                  type: string
                  description: Authorization code from Google
                state:
                  type: string
                  description: State parameter for CSRF protection
      responses:
        '200':
          description: OAuth callback handled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /functions/v1/sync-google-calendar:
    post:
      tags:
        - Google Calendar
      summary: Sync Google Calendar manually
      description: |
        Manually triggers a sync of Google Calendar events.
        This will fetch all events from Google Calendar and update the local database.
      operationId: syncGoogleCalendar
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - trainer_id
              properties:
                trainer_id:
                  type: string
                  format: uuid
                  description: The unique identifier of the trainer
      responses:
        '200':
          description: Sync initiated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Supabase JWT token obtained from authentication.
        Include in Authorization header: `Bearer <token>`

  schemas:
    CalendarClient:
      type: object
      required:
        - id
        - trainer_id
        - google_client_identifier
        - client_name
        - total_events_count
        - upcoming_events_count
        - completed_events_count
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the client
        trainer_id:
          type: string
          format: uuid
          description: ID of the trainer who owns this client
        trainee_id:
          type: string
          format: uuid
          nullable: true
          description: ID of the linked trainee (if linked)
        google_client_identifier:
          type: string
          description: Client identifier in Google Calendar (email or name)
        client_name:
          type: string
          description: Full name of the client
        client_email:
          type: string
          format: email
          nullable: true
          description: Email address of the client
        client_phone:
          type: string
          nullable: true
          description: Phone number of the client
        first_event_date:
          type: string
          format: date
          nullable: true
          description: Date of the first event with this client
        last_event_date:
          type: string
          format: date
          nullable: true
          description: Date of the most recent event with this client
        total_events_count:
          type: integer
          minimum: 0
          description: Total number of events with this client
        upcoming_events_count:
          type: integer
          minimum: 0
          description: Number of upcoming events
        completed_events_count:
          type: integer
          minimum: 0
          description: Number of completed events
        crm_data:
          type: object
          additionalProperties: true
          description: Additional CRM data stored as JSON
        created_at:
          type: string
          format: date-time
          description: Timestamp when the client record was created
        updated_at:
          type: string
          format: date-time
          description: Timestamp when the client record was last updated

    ClientInteraction:
      type: object
      required:
        - id
        - trainee_id
        - trainer_id
        - interaction_type
        - interaction_date
      properties:
        id:
          type: string
          format: uuid
          description: Unique identifier for the interaction
        trainee_id:
          type: string
          format: uuid
          description: ID of the trainee/client
        trainer_id:
          type: string
          format: uuid
          description: ID of the trainer
        interaction_type:
          type: string
          enum:
            - call
            - email
            - sms
            - meeting
            - workout
            - message
            - note
          description: Type of interaction
        interaction_date:
          type: string
          format: date-time
          description: Date and time of the interaction
        subject:
          type: string
          nullable: true
          description: Subject or title of the interaction
        description:
          type: string
          nullable: true
          description: Detailed description of the interaction
        outcome:
          type: string
          nullable: true
          description: Outcome of the interaction
        next_action:
          type: string
          nullable: true
          description: Next action required
        next_action_date:
          type: string
          format: date
          nullable: true
          description: Date for the next action
        google_event_id:
          type: string
          nullable: true
          description: Google Calendar event ID if linked
        created_at:
          type: string
          format: date-time
          description: Timestamp when the interaction was created

    CreateClientInteraction:
      type: object
      required:
        - trainee_id
        - trainer_id
        - interaction_type
      properties:
        trainee_id:
          type: string
          format: uuid
          description: ID of the trainee/client
        trainer_id:
          type: string
          format: uuid
          description: ID of the trainer
        interaction_type:
          type: string
          enum:
            - call
            - email
            - sms
            - meeting
            - workout
            - message
            - note
          description: Type of interaction
        interaction_date:
          type: string
          format: date-time
          nullable: true
          description: Date and time of the interaction (defaults to now if not provided)
        subject:
          type: string
          nullable: true
          description: Subject or title of the interaction
        description:
          type: string
          nullable: true
          description: Detailed description of the interaction
        outcome:
          type: string
          nullable: true
          description: Outcome of the interaction
        next_action:
          type: string
          nullable: true
          description: Next action required
        next_action_date:
          type: string
          format: date
          nullable: true
          description: Date for the next action
        google_event_id:
          type: string
          nullable: true
          description: Google Calendar event ID if linked

    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Error message
        code:
          type: string
          nullable: true
          description: Error code
        details:
          type: object
          nullable: true
          additionalProperties: true
          description: Additional error details

  responses:
    BadRequest:
      description: Bad request - Invalid input parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "trainerId הוא חובה"
            code: "VALIDATION_ERROR"

    Unauthorized:
      description: Unauthorized - Invalid or missing authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Unauthorized"
            code: "UNAUTHORIZED"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "שגיאה בטעינת לקוחות מה-Calendar"
            code: "INTERNAL_ERROR"
